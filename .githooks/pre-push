#!/bin/sh
# pre-push hook — validates HTML wallpapers before pushing
# Checks: DOCTYPE, <html lang>, <meta charset>, <meta viewport>, <title>
# Place this file at: .git/hooks/pre-push  (chmod +x if on Linux/Mac)

RED='\033[0;31m'
GRN='\033[0;32m'
YLW='\033[1;33m'
NC='\033[0m'

PASS=0
FAIL=0
WALLPAPER_DIR="assets/wallpapers"

# Only check HTML files that would actually be committed (not gitignored)
FILES=$(git diff --name-only --cached HEAD 2>/dev/null | grep "\.html$")
if [ -z "$FILES" ]; then
    # Fall back to checking staged files vs remote
    FILES=$(git diff --name-only origin/HEAD...HEAD 2>/dev/null | grep "\.html$")
fi
# Also always check the 3 canonical wallpapers if they exist
for f in \
    "$WALLPAPER_DIR/default.html" \
    "$WALLPAPER_DIR/temporal-flux.html" \
    "$WALLPAPER_DIR/memento-vivere.html"; do
    if [ -f "$f" ]; then
        FILES="$FILES
$f"
    fi
done

# Deduplicate
FILES=$(echo "$FILES" | sort -u | grep -v '^$')

if [ -z "$FILES" ]; then
    echo "${GRN}[pre-push] No HTML wallpapers to validate.${NC}"
    exit 0
fi

echo "${YLW}[pre-push] Validating HTML wallpapers...${NC}"

check_file() {
    local file="$1"
    local ok=1

    if [ ! -f "$file" ]; then return; fi

    # 1. DOCTYPE
    if ! grep -qi "<!DOCTYPE html>" "$file"; then
        echo "  ${RED}FAIL${NC} $file — missing <!DOCTYPE html>"
        ok=0
    fi

    # 2. <html lang="...">
    if ! grep -qi '<html[^>]*lang=' "$file"; then
        echo "  ${RED}FAIL${NC} $file — <html> missing lang attribute"
        ok=0
    fi

    # 3. meta charset
    if ! grep -qi '<meta[^>]*charset' "$file"; then
        echo "  ${RED}FAIL${NC} $file — missing <meta charset>"
        ok=0
    fi

    # 4. meta viewport
    if ! grep -qi '<meta[^>]*viewport' "$file"; then
        echo "  ${RED}FAIL${NC} $file — missing <meta name=\"viewport\">"
        ok=0
    fi

    # 5. <title> not empty
    if ! grep -qi '<title>[^<]\+</title>' "$file"; then
        echo "  ${RED}FAIL${NC} $file — missing or empty <title>"
        ok=0
    fi

    # 6. No hardcoded absolute paths (Windows-style C:\ or D:\)
    if grep -q '[A-Z]:\\\\' "$file" 2>/dev/null || grep -P '[A-Z]:\\' "$file" 2>/dev/null; then
        echo "  ${RED}FAIL${NC} $file — contains hardcoded Windows path (e.g. C:\\...)"
        ok=0
    fi

    # 7. No hardcoded birth year / age constants (warn only)
    if grep -qE 'const\s+(age|avgAge|birthYear)\s*=\s*[0-9]+' "$file" 2>/dev/null; then
        echo "  ${YLW}WARN${NC} $file — hardcoded age/birthYear constant detected (sanitise before push)"
        ok=0
    fi

    if [ "$ok" -eq 1 ]; then
        echo "  ${GRN}OK${NC}   $file"
        PASS=$((PASS + 1))
    else
        FAIL=$((FAIL + 1))
    fi
}

echo "$FILES" | while IFS= read -r f; do
    check_file "$f"
done

# Re-evaluate counts outside subshell (POSIX workaround)
FAIL_COUNT=$(echo "$FILES" | while IFS= read -r f; do
    [ -f "$f" ] || continue
    grep -qi "<!DOCTYPE html>" "$f" || { echo F; continue; }
    grep -qi '<html[^>]*lang=' "$f"  || { echo F; continue; }
    grep -qi '<meta[^>]*charset' "$f" || { echo F; continue; }
    grep -qi '<meta[^>]*viewport' "$f" || { echo F; continue; }
    grep -qi '<title>[^<]\+</title>' "$f" || { echo F; continue; }
    grep -qP '[A-Z]:\\' "$f" 2>/dev/null && { echo F; continue; }
    grep -qE 'const\s+(age|avgAge|birthYear)\s*=\s*[0-9]+' "$f" 2>/dev/null && { echo F; continue; }
done | wc -l)

echo ""
if [ "$FAIL_COUNT" -gt 0 ]; then
    echo "${RED}[pre-push] $FAIL_COUNT file(s) failed validation. Push aborted.${NC}"
    echo "Fix the issues above and try again."
    exit 1
else
    echo "${GRN}[pre-push] All HTML wallpapers passed validation. Pushing...${NC}"
    exit 0
fi
